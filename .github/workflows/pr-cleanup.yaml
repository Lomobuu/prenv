name: Cleanup PR Terraform Backend

permissions:
  id-token: write
  contents: read

on:
  pull_request:
    branches:
      - main    # only run on PRs targeting main
    types: [closed]

jobs:
  cleanup:
    runs-on: ubuntu-latest
    env:
      environment: pr${{ github.event.pull_request.number }}
      RESOURCE_GROUP: prenv-management-RG
      STORAGE_ACCOUNT: tfstateprenvfozzen
      location: westeurope
      PR_ID: ${{ github.event.pull_request.number }}
      BACKEND_CONTAINER: tfstate-pr${{ github.event.pull_request.number }}
      ARM_CLIENT_ID: ${{ secrets.AZURE_CLIENT_ID }}
      ARM_SUBSCRIPTION_ID: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
      ARM_TENANT_ID: ${{ secrets.AZURE_TENANT_ID }}
    defaults:
      run:
        working-directory: .github/Terraform
        shell: bash
    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v1

      - name: Terraform Init
        run: terraform init -backend-config="resource_group_name=$RESOURCE_GROUP" -backend-config="storage_account_name=$STORAGE_ACCOUNT" -backend-config="container_name=tfstate-$environment" -backend-config="key=terraform.tfstate" -backend-config="use_oidc=true"

      - name: Terraform Destroy
        run: terraform destroy -auto-approve -input=false -var location=$location -var environment=$environment